<!doctype html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Brew Journal + World Map</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    :root { --bg:#0b0f19; --fg:#e5e7eb; }
    body{ background:var(--bg); color:var(--fg); font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial }
    .btn{ display:inline-flex; align-items:center; gap:.5rem; padding:.5rem .75rem; border-radius:.75rem; background:#262626; color:#e5e7eb; font-size:.875rem }
    .btn:hover{ background:#3f3f46 }
    .input{ background:#0a0a0a; border:1px solid #3f3f46; border-radius:.5rem; padding:.5rem .75rem; width:100%; color:#e5e7eb }
    .card{ background:rgba(23,23,23,.7); border:1px solid #262626; border-radius:1rem; padding:1rem; box-shadow:0 1px 3px rgba(0,0,0,.2) }
    .badge{ font-size:.75rem; border-radius:9999px; padding:.25rem .5rem; background:#262626; border:1px solid #3f3f46 }
    .link{ color:#93c5fd }
  </style>
</head>
<body>
<div id="root"></div>

<script type="module">
/* Core CDN modules (lightweight, safe to load up front) */
import React, {useEffect,useMemo,useRef,useState} from "https://esm.sh/react@18";
import {createRoot} from "https://esm.sh/react-dom@18/client";
import {HashRouter, Routes, Route, Link, NavLink, useNavigate, useParams, useLocation} from "https://esm.sh/react-router-dom@6";
import create from "https://esm.sh/zustand@4";
import {useForm} from "https://esm.sh/react-hook-form@7";
import {z} from "https://esm.sh/zod@3";
import {zodResolver} from "https://esm.sh/@hookform/resolvers@3/zod";
import {nanoid} from "https://esm.sh/nanoid@4";
import {LineChart, Line, XAxis, YAxis, Tooltip, ResponsiveContainer, CartesianGrid} from "https://esm.sh/recharts@2?deps=react@18,react-dom@18";

/* ------- Utils & Schemas ------- */
const ISO3_TO_NAME={ETH:'Ethiopia',KEN:'Kenya',COL:'Colombia',BRA:'Brazil',GTM:'Guatemala',PAN:'Panama',USA:'United States',JPN:'Japan'};
const nameFromISO3=c=>ISO3_TO_NAME[c?.toUpperCase()]??(c?.toUpperCase()||"Unknown");

const BeanSchema=z.object({
  id:z.string(),name:z.string().min(1),roaster:z.string().optional(),
  originCountry:z.string().length(3),originRegion:z.string().optional(),farm:z.string().optional(),
  variety:z.array(z.string()).default([]),process:z.string().optional(),altitudeM:z.number().int().nonnegative().optional(),
  roastLevel:z.enum(['light','medium','dark']).optional(),roastDate:z.string().optional(),purchaseDate:z.string().optional(),
  priceJPY:z.number().nonnegative().optional(),tastingNotes:z.array(z.string()).default([]),
  cuppingScore:z.number().min(0).max(100).optional(),labelPhoto:z.string().optional(),
  tried:z.boolean().default(false),createdAt:z.string(),updatedAt:z.string()
});
const BrewSchema=z.object({
  id:z.string(),beanId:z.string(),date:z.string(),method:z.string(),
  doseG:z.number(),waterG:z.number(),ratio:z.string().optional(),tempC:z.number().optional(),
  grindNote:z.string().optional(),timeSec:z.number().optional(),steps:z.array(z.string()).default([]),
  tds:z.number().optional(),extractionYield:z.number().optional(),rating:z.number().min(1).max(5).optional(),
  notes:z.string().optional(),attachments:z.array(z.string()).optional()
});

/* ------- DataService (localStorage) ------- */
const STORAGE_KEY="bjwm_v1";
const defaultDB={version:1,beans:[],brews:[]};
const DataService={
  load(){try{const raw=localStorage.getItem(STORAGE_KEY);if(!raw)return structuredClone(defaultDB);const db=JSON.parse(raw);db.version??=1;db.beans??=[];db.brews??=[];return db;}catch{ return structuredClone(defaultDB);}},
  save(db){try{localStorage.setItem(STORAGE_KEY,JSON.stringify(db));}catch{}},
  reset(){try{localStorage.removeItem(STORAGE_KEY);}catch{}},
  export(db){return JSON.stringify(db,null,2);}
};

/* ------- Store (Zustand) ------- */
const useStore=create((set,get)=>({
  beans:[],brews:[],
  addBean:b=>{const bean={...b,id:nanoid(),createdAt:new Date().toISOString(),updatedAt:new Date().toISOString()};set(s=>({beans:[bean,...s.beans]}));persist();return bean;},
  updateBean:(id,patch)=>{set(s=>({beans:s.beans.map(b=>b.id===id?{...b,...patch,updatedAt:new Date().toISOString()}:b)}));persist();},
  deleteBean:id=>{set(s=>({beans:s.beans.filter(b=>b.id!==id),brews:s.brews.filter(br=>br.beanId!==id)}));persist();},
  addBrew:x=>{const brew={...x,id:nanoid()};set(s=>({brews:[brew,...s.brews]}));persist();return brew;},
  updateBrew:(id,patch)=>{set(s=>({brews:s.brews.map(b=>b.id===id?{...b,...patch}:b)}));persist();},
  deleteBrew:id=>{set(s=>({brews:s.brews.filter(b=>b.id!==id)}));persist();},
  importJSON:data=>{set({beans:data.beans??[],brews:data.brews??[]});persist();},
  exportJSON:()=>DataService.export({version:1,beans:get().beans,brews:get().brews}),
  seedIfEmpty:()=>{
    const s=get(); if(s.beans.length||s.brews.length) return;
    const now=new Date().toISOString();
    const seeds=[
      {id:nanoid(),name:"Yirgacheffe Washed",roaster:"Tokyo Roasters",originCountry:"ETH",originRegion:"Yirgacheffe",variety:["Heirloom"],process:"Washed",roastLevel:"light",roastDate:now,purchaseDate:now,priceJPY:1800,tastingNotes:["jasmine","citrus"],cuppingScore:88,tried:true,createdAt:now,updatedAt:now},
      {id:nanoid(),name:"Nyeri AA",roaster:"Osaka Beans",originCountry:"KEN",originRegion:"Nyeri",variety:["SL28","SL34"],process:"Washed",roastLevel:"light",priceJPY:2000,tastingNotes:["blackcurrant","grapefruit"],cuppingScore:90,tried:true,createdAt:now,updatedAt:now},
      {id:nanoid(),name:"Huila Pink Bourbon",roaster:"Kanto Coffee",originCountry:"COL",originRegion:"Huila",variety:["Pink Bourbon"],process:"Washed",roastLevel:"light",priceJPY:2200,tastingNotes:["floral","stone fruit"],cuppingScore:89,tried:true,createdAt:now,updatedAt:now},
      {id:nanoid(),name:"Cerrado Natural",roaster:"Blue Bottle",originCountry:"BRA",originRegion:"Cerrado",process:"Natural",roastLevel:"medium",priceJPY:1500,tastingNotes:["chocolate","nutty"],cuppingScore:84,tried:false,createdAt:now,updatedAt:now},
      {id:nanoid(),name:"Antigua",roaster:"Nagoya Coffee",originCountry:"GTM",originRegion:"Antigua",process:"Washed",roastLevel:"medium",priceJPY:1700,tastingNotes:["cocoa","spice"],cuppingScore:85,tried:false,createdAt:now,updatedAt:now},
      {id:nanoid(),name:"Boquete Geisha Natural",roaster:"Specialty JP",originCountry:"PAN",originRegion:"Boquete",variety:["Geisha"],process:"Natural",roastLevel:"light",priceJPY:4500,tastingNotes:["bergamot","tropical"],cuppingScore:92,tried:true,createdAt:now,updatedAt:now},
    ];
    const brews=[
      {id:nanoid(),beanId:seeds[0].id,date:now,method:"V60",doseG:15,waterG:240,ratio:"1:16",tempC:94,timeSec:150,steps:["Bloom 30s","Pour to 240g"],rating:5,notes:"Delicate jasmine."},
      {id:nanoid(),beanId:seeds[1].id,date:now,method:"FrenchPress",doseG:18,waterG:270,ratio:"1:15",tempC:94,timeSec:240,steps:["4:00","Skim crust"],rating:4,notes:"Blackcurrant pop."},
      {id:nanoid(),beanId:seeds[2].id,date:now,method:"Siphon",doseG:20,waterG:300,ratio:"1:15",tempC:92,timeSec:210,steps:["Assemble","Draw down"],rating:5,notes:"Elegant."},
      {id:nanoid(),beanId:seeds[3].id,date:now,method:"IcedFrenchPress",doseG:18,waterG:180,ratio:"bypass 120g ice",tempC:95,timeSec:150,steps:["Add ice","Steep 2:30","Press"],rating:4,notes:"Chocolate soda."},
      {id:nanoid(),beanId:seeds[5].id,date:now,method:"Espresso",doseG:18,waterG:36,ratio:"1:2",tempC:94,timeSec:30,steps:["18 in, 36 out"],rating:5,notes:"Perfumed."}
    ];
    set({beans:seeds,brews});persist();
  }
}));
function persist(){const s=useStore.getState();DataService.save({version:1,beans:s.beans,brews:s.brews});}
(function bootstrap(){const db=DataService.load();useStore.setState({beans:db.beans,brews:db.brews});if(!db.beans.length&&!db.brews.length)useStore.getState().seedIfEmpty();})();

/* ------- Helpers ------- */
const useQuery=()=>new URLSearchParams(useLocation().search);
function download(filename, text){const blob=new Blob([text],{type:"application/json"});const url=URL.createObjectURL(blob);const a=document.createElement("a");a.href=url;a.download=filename;a.click();setTimeout(()=>URL.revokeObjectURL(url),500);}

/* ------- UI ------- */
function TopNav(){
  const inputRef=useRef(null);const navigate=useNavigate();
  useEffect(()=>{const onKey=e=>{if((e.ctrlKey||e.metaKey)&&e.key.toLowerCase()==='k'){e.preventDefault();inputRef.current?.focus();}};window.addEventListener('keydown',onKey);return()=>window.removeEventListener('keydown',onKey);},[]);
  return (
    <div className="sticky top-0 z-10 backdrop-blur bg-neutral-950/70 border-b border-neutral-800">
      <div className="max-w-6xl mx-auto px-4 py-3 flex items-center gap-3">
        <div className="font-semibold">Brew Journal + World Map</div>
        <nav className="flex items-center gap-3 text-sm">
          <NavLink to="/" className={({isActive})=>isActive?'badge':'opacity-70 hover:opacity-100'}>Home</NavLink>
          <NavLink to="/beans" className={({isActive})=>isActive?'badge':'opacity-70 hover:opacity-100'}>Beans</NavLink>
          <NavLink to="/brews" className={({isActive})=>isActive?'badge':'opacity-70 hover:opacity-100'}>Brews</NavLink>
          <NavLink to="/map" className={({isActive})=>isActive?'badge':'opacity-70 hover:opacity-100'}>Map</NavLink>
          <NavLink to="/settings" className={({isActive})=>isActive?'badge':'opacity-70 hover:opacity-100'}>Settings</NavLink>
        </nav>
        <div className="flex-1"></div>
        <input ref={inputRef} placeholder="Search (âŒ˜/Ctrl+K)" className="input max-w-xs"
          onKeyDown={e=>{if(e.key==='Enter') navigate('/beans?search='+encodeURIComponent(e.target.value));}} />
      </div>
    </div>
  );
}

function Home(){
  const beans=useStore(s=>s.beans), brews=useStore(s=>s.brews);
  return (
    <div className="grid md:grid-cols-2 gap-6">
      <div className="card">
        <h2 className="text-lg font-semibold mb-2">Quick Start</h2>
        <div className="flex gap-2">
          <Link className="btn" to="/beans">Manage Beans</Link>
          <Link className="btn" to="/brews">Log Brews</Link>
          <Link className="btn" to="/map">World Map</Link>
        </div>
      </div>
      <div className="card">
        <h2 className="text-lg font-semibold mb-2">This Week</h2>
        <p className="text-sm text-neutral-300">Beans tracked: <span className="badge">{beans.length}</span></p>
        <p className="text-sm text-neutral-300">Brews logged: <span className="badge">{brews.length}</span></p>
        <div className="mt-4 h-40">
          <ResponsiveContainer width="100%" height="100%">
            <LineChart data={brews.map(b=>({date:b.date,rating:b.rating||0}))}>
              <CartesianGrid strokeDasharray="3 3" />
              <XAxis dataKey="date" hide />
              <YAxis domain={[0,5]} />
              <Tooltip />
              <Line type="monotone" dataKey="rating" stroke="#60a5fa" dot={false} />
            </LineChart>
          </ResponsiveContainer>
        </div>
      </div>
    </div>
  );
}

function BeanForm({defaultValues={}, onSubmit}){
  const schema=BeanSchema.omit({id:true,createdAt:true,updatedAt:true});
  const {register,handleSubmit,formState:{errors}}=useForm({resolver:zodResolver(schema),defaultValues:{name:"",originCountry:"ETH",variety:[],tastingNotes:[],tried:false,...defaultValues}});
  return (
    <form onSubmit={handleSubmit(v=>onSubmit(v))} className="space-y-3">
      <div><label className="text-sm">Name</label><input className="input" {...register('name')} />{errors.name&&<p className="text-red-400 text-xs">{String(errors.name.message)}</p>}</div>
      <div><label className="text-sm">Roaster</label><input className="input" {...register('roaster')} /></div>
      <div className="grid grid-cols-2 gap-2">
        <div><label className="text-sm">Origin (ISO3)</label><input className="input" {...register('originCountry')} /></div>
        <div><label className="text-sm">Process</label><input className="input" {...register('process')} /></div>
      </div>
      <div className="grid grid-cols-2 gap-2">
        <div><label className="text-sm">Roast Level</label>
          <select className="input" {...register('roastLevel')}>
            <option value="">-</option><option value="light">light</option><option value="medium">medium</option><option value="dark">dark</option>
          </select>
        </div>
        <div className="flex items-center gap-2 mt-7"><input type="checkbox" className="w-4 h-4" {...register('tried')} /><span className="text-sm">Tried</span></div>
      </div>
      <div className="grid grid-cols-2 gap-2">
        <div><label className="text-sm">Roast Date</label><input type="date" className="input" {...register('roastDate')} /></div>
        <div><label className="text-sm">Purchase Date</label><input type="date" className="input" {...register('purchaseDate')} /></div>
      </div>
      <div><label className="text-sm">Tasting Notes (comma-separated)</label>
        <input className="input" {...register('tastingNotes',{setValueAs:v=>(typeof v==='string'?v.split(',').map(x=>x.trim()).filter(Boolean):v)})} />
      </div>
      <button className="btn" type="submit">Save Bean</button>
    </form>
  );
}

function BeansPage(){
  const q=useQuery().get('search')?.toLowerCase()??"";
  const beans=useStore(s=>s.beans);
  const addBean=useStore(s=>s.addBean), updateBean=useStore(s=>s.updateBean), deleteBean=useStore(s=>s.deleteBean);
  const exportJSON=useStore(s=>s.exportJSON), importJSON=useStore(s=>s.importJSON);
  const [showForm,setShowForm]=useState(false);
  const [filters,setFilters]=useState({origin:"",process:"",roastLevel:"",tried:""});
  const filtered=beans
    .filter(b=>b.name.toLowerCase().includes(q)||(b.roaster||"").toLowerCase().includes(q)||(b.originCountry||"").toLowerCase().includes(q))
    .filter(b=>!filters.origin||b.originCountry===filters.origin)
    .filter(b=>!filters.process||b.process===filters.process)
    .filter(b=>!filters.roastLevel||b.roastLevel===filters.roastLevel)
    .filter(b=>!filters.tried||String(b.tried)===filters.tried);

  function handleExport(){download("brew-journal.json",exportJSON());}
  function handleImport(e){const f=e.target.files?.[0];if(!f)return;const r=new FileReader();r.onload=()=>{try{importJSON(JSON.parse(String(r.result)));alert("Import complete");}catch{alert("Invalid JSON");}};r.readAsText(f);}

  return (
    <div className="space-y-4">
      <div className="flex items-center justify-between">
        <h1 className="text-xl font-semibold">Beans</h1>
        <div className="flex items-center gap-2">
          <select className="input w-28" value={filters.origin} onChange={e=>setFilters(f=>({...f,origin:e.target.value}))}>
            <option value="">Origin</option>{[...new Set(beans.map(b=>b.originCountry))].map(x=><option key={x} value={x}>{x}</option>)}
          </select>
          <select className="input w-32" value={filters.process} onChange={e=>setFilters(f=>({...f,process:e.target.value}))}>
            <option value="">Process</option>{[...new Set(beans.map(b=>b.process).filter(Boolean))].map(x=><option key={x} value={x}>{x}</option>)}
          </select>
          <select className="input w-32" value={filters.roastLevel} onChange={e=>setFilters(f=>({...f,roastLevel:e.target.value}))}>
            <option value="">Roast</option>{["light","medium","dark"].map(x=><option key={x} value={x}>{x}</option>)}
          </select>
          <select className="input w-24" value={filters.tried} onChange={e=>setFilters(f=>({...f,tried:e.target.value}))}>
            <option value="">Tried?</option><option value="true">Yes</option><option value="false">No</option>
          </select>
          <label className="btn cursor-pointer">Import JSON<input type="file" accept="application/json" className="hidden" onChange={handleImport}/></label>
          <button className="btn" onClick={handleExport}>Export JSON</button>
          <button className="btn" onClick={()=>setShowForm(v=>!v)}>+ Add New Bean</button>
        </div>
      </div>

      {showForm && <div className="card"><BeanForm onSubmit={b=>{addBean(b);setShowForm(false);}}/></div>}

      <div className="grid gap-2">
        <div className="grid grid-cols-7 text-xs text-neutral-400 px-2">
          <div>Name</div><div>Roaster</div><div>Origin</div><div>Process</div><div>Roast</div><div>Tried</div><div>Actions</div>
        </div>
        {filtered.map(b=>
          <div key={b.id} className="grid grid-cols-7 items-center bg-neutral-900/60 border border-neutral-800 rounded-xl px-2 py-2">
            <div className="truncate"><Link className="link" to={"/beans/"+b.id}>{b.name}</Link></div>
            <div className="truncate">{b.roaster??"â€”"}</div>
            <div>{b.originCountry}</div>
            <div>{b.process??"â€”"}</div>
            <div>{b.roastLevel??"â€”"}</div>
            <div><input type="checkbox" checked={b.tried} onChange={e=>updateBean(b.id,{tried:e.target.checked})}/></div>
            <div className="flex gap-2 justify-end">
              <Link className="btn" to={"/beans/"+b.id}>Open</Link>
              <button className="btn" onClick={()=>{if(confirm("Delete bean?")) deleteBean(b.id);}}>Delete</button>
            </div>
          </div>
        )}
      </div>
    </div>
  );
}

function BrewForm({defaultValues={}, onSubmit}){
  const schema=BrewSchema.omit({id:true});
  const {register,handleSubmit}=useForm({resolver:zodResolver(schema),defaultValues:{date:new Date().toISOString().slice(0,10),method:"V60",doseG:15,waterG:240,steps:["Bloom 30s","Pour to 240g"],...defaultValues}});
  return (
    <form onSubmit={handleSubmit(v=>onSubmit(v))} className="space-y-3">
      <div className="grid grid-cols-2 gap-2">
        <div><label className="text-sm">Date</label><input type="date" className="input" {...register('date')}/></div>
        <div><label className="text-sm">Method</label>
          <select className="input" {...register('method')}>{["V60","AeroPress","FrenchPress","Siphon","Espresso","Batch","IcedFrenchPress"].map(m=><option key={m}>{m}</option>)}</select>
        </div>
      </div>
      <div className="grid grid-cols-3 gap-2">
        <div><label className="text-sm">Dose (g)</label><input type="number" step="1" className="input" {...register('doseG',{valueAsNumber:true})}/></div>
        <div><label className="text-sm">Water (g)</label><input type="number" step="1" className="input" {...register('waterG',{valueAsNumber:true})}/></div>
        <div><label className="text-sm">Ratio</label><input className="input" placeholder="1:16 or notes" {...register('ratio')}/></div>
      </div>
      <div className="grid grid-cols-2 gap-2">
        <div><label className="text-sm">Temp (Â°C)</label><input type="number" step="1" className="input" {...register('tempC',{valueAsNumber:true})}/></div>
        <div><label className="text-sm">Time (sec)</label><input type="number" step="1" className="input" {...register('timeSec',{valueAsNumber:true})}/></div>
      </div>
      <div><label className="text-sm">Steps (comma-separated)</label>
        <input className="input" {...register('steps',{setValueAs:v=>(typeof v==='string'?v.split(',').map(x=>x.trim()).filter(Boolean):v)})}/>
      </div>
      <div><label className="text-sm">Notes</label><textarea rows="3" className="input" {...register('notes')}/></div>
      <button className="btn" type="submit">Save Brew</button>
    </form>
  );
}

function BeanDetail(){
  const {id}=useParams();
  const bean=useStore(s=>s.beans.find(b=>b.id===id));
  const brews=useStore(s=>s.brews.filter(b=>b.beanId===id));
  const addBrew=useStore(s=>s.addBrew), updateBean=useStore(s=>s.updateBean), deleteBean=useStore(s=>s.deleteBean);
  const [open,setOpen]=useState(false);
  if(!bean) return <div className="card">Bean not found. <Link className="link" to="/beans">Back</Link></div>;
  return (
    <div className="space-y-4">
      <div className="flex items-center justify-between">
        <h1 className="text-xl font-semibold">{bean.name}</h1>
        <div className="flex gap-2">
          <button className="btn" onClick={()=>setOpen(v=>!v)}>Make New Brew</button>
          <button className="btn" onClick={()=>{if(confirm("Delete bean?")){deleteBean(bean.id);location.hash="#/beans";}}}>Delete Bean</button>
        </div>
      </div>
      <div className="grid md:grid-cols-2 gap-4">
        <div className="card space-y-1">
          <div className="text-sm text-neutral-300">Origin: {bean.originRegion?bean.originRegion+", ":""}{bean.originCountry}</div>
          <div className="text-sm text-neutral-300">Process: {bean.process??"â€”"}</div>
          <div className="text-sm text-neutral-300">Tasting: {(bean.tastingNotes||[]).join(', ')||"â€”"}</div>
          <label className="flex items-center gap-2 text-sm mt-2"><input type="checkbox" checked={bean.tried} onChange={e=>updateBean(bean.id,{tried:e.target.checked})}/>Tried</label>
        </div>
        <div className="card">
          <h3 className="font-medium mb-2">Brews</h3>
          <div className="space-y-2">
            {brews.map(br=><div key={br.id} className="bg-neutral-900/60 border border-neutral-800 rounded-xl px-3 py-2">
              <div className="text-sm">{`${br.date} â€” ${br.method} â€” ${br.doseG}g â†’ ${br.waterG}g`}</div>
              <div className="text-xs text-neutral-400">{br.notes??"â€”"}</div>
            </div>)}
            {brews.length===0 && <div className="text-sm text-neutral-400">No brews yet.</div>}
          </div>
          <div className="mt-2 h-40">
            <ResponsiveContainer width="100%" height="100%">
              <LineChart data={brews.map(x=>({x:x.date,y:x.rating||0}))}>
                <XAxis dataKey="x" hide /><YAxis domain={[0,5]} /><Tooltip />
                <Line type="monotone" dataKey="y" stroke="#34d399" dot={false}/>
              </LineChart>
            </ResponsiveContainer>
          </div>
        </div>
      </div>
      {open && <div className="card"><BrewForm defaultValues={{beanId:bean.id}} onSubmit={b=>{addBrew({...b,beanId:bean.id});setOpen(false);alert("Brew saved");}}/></div>}
    </div>
  );
}

/* ------- Lazy PDF export (no startup import) ------- */
async function exportBrewsPDF(brews, beans){
  try{
    const mod = await import("https://esm.sh/@react-pdf/renderer@3?bundle");
    const {Document, Page, Text, View, StyleSheet, pdf} = mod;
    const styles = StyleSheet.create({page:{padding:24,fontSize:12},h1:{fontSize:18,marginBottom:8},row:{marginBottom:8,paddingBottom:6,borderBottom:"1px solid #ddd"}});
    const name=id=>beans.find(b=>b.id===id)?.name??"Unknown";
    const doc = React.createElement(Document,null,
      React.createElement(Page,{size:"A4",style:styles.page},
        React.createElement(Text,{style:styles.h1},"Brew Journal Export"),
        brews.map((br,i)=>React.createElement(View,{key:i,style:styles.row},
          React.createElement(Text,null,`${name(br.beanId)} â€” ${br.method} â€” ${br.date}`),
          React.createElement(Text,null,`Dose ${br.doseG}g, Water ${br.waterG}g, Temp ${br.tempC??"-"}Â°C, Time ${br.timeSec??"-"}s, Ratio ${br.ratio??"-"}`),
          React.createElement(Text,null,`Rating: ${br.rating??"-"}`),
          br.notes?React.createElement(Text,null,`Notes: ${br.notes}`):null
        ))
      )
    );
    const blob = await pdf(doc).toBlob();
    const url=URL.createObjectURL(blob);const a=document.createElement("a");a.href=url;a.download="brews.pdf";a.click();setTimeout(()=>URL.revokeObjectURL(url),500);
  }catch(e){alert("PDF export is blocked on this host. Try Vercel/Netlify.");console.warn(e);}
}

function BrewsPage(){
  const brews=useStore(s=>s.brews);const beans=useStore(s=>s.beans);
  const [selected,setSelected]=useState([]);const toggle=id=>setSelected(s=>s.includes(id)?s.filter(x=>x!==id):[...s,id]);
  const chosen=brews.filter(b=>selected.includes(b.id));
  return (
    <div className="space-y-4">
      <div className="flex items-center justify-between">
        <h1 className="text-xl font-semibold">Brews</h1>
        <div className="flex gap-2">
          <button className="btn" disabled={!chosen.length} onClick={()=>exportBrewsPDF(chosen,beans)}>Export PDF</button>
        </div>
      </div>
      <div className="space-y-2">
        {brews.map(b=>
          <label key={b.id} className="grid grid-cols-6 items-center bg-neutral-900/60 border border-neutral-800 rounded-xl px-2 py-2">
            <input type="checkbox" checked={selected.includes(b.id)} onChange={()=>toggle(b.id)}/>
            <div className="col-span-2">{beans.find(x=>x.id===b.beanId)?.name??"Unknown"}</div>
            <div>{b.method}</div><div>{b.date}</div>
            <div className="text-sm text-neutral-400">{b.notes??"â€”"}</div>
          </label>
        )}
      </div>
    </div>
  );
}

/* ------- Lazy World Map (no startup import) ------- */
function LazyWorldMap({onSelect}){
  const [MapComp,setMapComp]=useState(null);
  const beans=useStore(s=>s.beans);
  const triedCounts=useMemo(()=>{const m={};for(const b of beans){if(b.tried)m[b.originCountry]=(m[b.originCountry]||0)+1;}return m;},[beans]);

  useEffect(()=>{(async()=>{
    try{
      const mod=await import("https://esm.sh/react-simple-maps@3?deps=d3-geo,topojson-client,react@18,react-dom@18");
      const {ComposableMap,Geographies,Geography}=mod;
      const GEO_URL="https://cdn.jsdelivr.net/npm/world-atlas@2/countries-110m.json";
      const Comp=()=> {
        const values=Object.values(triedCounts); const max=values.length?Math.max(...values):1;
        const [hover,setHover]=useState(null);
        const colorFor=(v,max)=> v===0?"#1f2937":`rgb(${Math.floor(200+55*(v/max))},120,40)`;
        return (
          <div className="w-full h-[480px] relative">
            <ComposableMap projectionConfig={{scale:150}}>
              <Geographies geography={GEO_URL}>
                {({geographies})=>geographies.map(geo=>{
                  const iso3=geo.properties.iso_a3; const count=triedCounts[iso3]||0;
                  return <Geography key={geo.rsmKey} geography={geo}
                    onMouseEnter={()=>setHover({name:geo.properties.name,count})}
                    onMouseLeave={()=>setHover(null)} onClick={()=>onSelect(iso3)}
                    style={{default:{fill:colorFor(count,max),outline:"none"},hover:{fill:"#f59e0b",outline:"none"},pressed:{fill:"#f59e0b",outline:"none"}}}/>;
                })}
              </Geographies>
            </ComposableMap>
            {hover && <div className="absolute left-2 bottom-2 p-2 bg-neutral-800 border border-neutral-700 rounded-lg text-sm">
              {hover.name}: {hover.count} bean{hover.count===1?"":"s"} tried
            </div>}
          </div>
        );
      };
      setMapComp(()=>Comp);
    }catch(e){console.warn("Map blocked by host",e);setMapComp(()=>()=> <div className="p-3 card">Map is blocked on this host. Try Vercel/Netlify.</div>);}
  })();},[triedCounts,onSelect]);

  return MapComp? <MapComp/> : <div className="p-3 card">Loading mapâ€¦</div>;
}

function CountryDrawer({iso3,onClose}){
  const beans=useStore(s=>s.beans);const addBean=useStore(s=>s.addBean);
  if(!iso3) return null; const list=beans.filter(b=>b.originCountry===iso3&&b.tried);
  return (
    <div className="fixed right-0 top-0 h-full w-full sm:w-[420px] bg-neutral-950 border-l border-neutral-800 p-4 overflow-y-auto z-20">
      <div className="flex items-center justify-between">
        <h3 className="text-lg font-semibold">{nameFromISO3(iso3)} â€” Tried Beans</h3>
        <button className="btn" onClick={onClose}>Close</button>
      </div>
      <div className="mt-3 space-y-2">
        {list.length===0 && <p className="text-sm text-neutral-400">No tried beans yet.</p>}
        {list.map(b=><div className="card" key={b.id}>
          <div className="font-medium">{b.name}</div>
          <div className="text-sm text-neutral-400">{b.roaster??"â€”"} Â· {b.process??"â€”"}</div>
          <div className="mt-2"><Link className="btn" to={"/beans/"+b.id} onClick={onClose}>View Bean</Link></div>
        </div>)}
      </div>
      <div className="mt-4">
        <button className="btn" onClick={()=>{const bean=addBean({name:"New Bean",roaster:"",originCountry:iso3,originRegion:"",farm:"",variety:[],process:"",tried:true});onClose();location.hash="#/beans/"+bean.id;}}>Add Bean (prefilled)</button>
      </div>
    </div>
  );
}

function MapPage(){
  const beans=useStore(s=>s.beans);const [country,setCountry]=useState(null);
  const stats=useMemo(()=>{
    const tried=beans.filter(b=>b.tried); const by={};
    for(const b of tried){by[b.originCountry]=by[b.originCountry]||{count:0,sum:0,n:0};by[b.originCountry].count++;if(b.cuppingScore){by[b.originCountry].sum+=b.cuppingScore;by[b.originCountry].n++;}}
    const entries=Object.entries(by); const total=entries.length; const top=entries.sort((a,b)=>b[1].count-a[1].count)[0]?.[0]??"â€”";
    const hi=entries.map(([k,v])=>[k,v.n?Math.round(v.sum/v.n):0]).sort((a,b)=>b[1]-a[1])[0]; return {total,top,hi};
  },[beans]);
  return (
    <div className="space-y-4">
      <h1 className="text-xl font-semibold">World Map</h1>
      <div className="flex gap-2 text-sm">
        <span className="badge">Countries Tried: {stats.total}</span>
        <span className="badge">Top Origin: {stats.top}</span>
        <span className="badge">Highest Avg Score: {stats.hi?`${stats.hi[0]} (${stats.hi[1]})`:"â€”"}</span>
      </div>
      <div className="card"><LazyWorldMap onSelect={setCountry}/></div>
      <CountryDrawer iso3={country} onClose={()=>setCountry(null)}/>
    </div>
  );
}

function SettingsPage(){
  const exportJSON=useStore(s=>s.exportJSON), importJSON=useStore(s=>s.importJSON);
  function handleExport(){download("brew-journal.json",exportJSON());}
  function handleImport(e){const f=e.target.files?.[0];if(!f)return;const r=new FileReader();r.onload=()=>{try{importJSON(JSON.parse(String(r.result)));alert("Import complete");}catch{alert("Invalid JSON");}};r.readAsText(f);}
  return (
    <div className="space-y-4">
      <h1 className="text-xl font-semibold">Settings</h1>
      <div className="card space-y-3">
        <div className="flex gap-2">
          <label className="btn cursor-pointer">Import JSON<input type="file" accept="application/json" className="hidden" onChange={handleImport}/></label>
          <button className="btn" onClick={handleExport}>Export JSON</button>
        </div>
        <button className="btn" onClick={()=>{if(confirm("Reset all data?")){DataService.reset();location.reload();}}}>Reset Data</button>
        <p className="text-xs text-neutral-400">Data is stored locally in your browser (offline). Export regularly for backup.</p>
      </div>
    </div>
  );
}

/* ------- Router + Mount ------- */
function App(){
  return (
    <div className="min-h-screen">
      <TopNav/>
      <div className="max-w-6xl mx-auto p-4">
        <Routes>
          <Route path="/" element={<Home/>}/>
          <Route path="/beans" element={<BeansPage/>}/>
          <Route path="/beans/:id" element={<BeanDetail/>}/>
          <Route path="/brews" element={<BrewsPage/>}/>
          <Route path="/map" element={<MapPage/>}/>
          <Route path="/settings" element={<SettingsPage/>}/>
        </Routes>
      </div>
    </div>
  );
}
const root=createRoot(document.getElementById("root"));
root.render(<React.StrictMode><HashRouter><App/></HashRouter></React.StrictMode>);
</script>
</body>
</html>
